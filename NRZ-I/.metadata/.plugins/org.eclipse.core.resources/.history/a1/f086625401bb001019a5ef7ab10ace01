/*******************************************************************************
* File Name:   main.c
*
* Description:
*   Receives data via SPI (slave) and encodes it as NRZ-I on P9_0
*
* Flow:
*   1. SPI Master sends data
*   2. PSoC receives data via SPI slave
*   3. Data is encoded to NRZ-I on P9_0
*   4. P9_0 can be read by external device or logic analyzer
*
********************************************************************************/

#include "cyhal.h"
#include "cybsp.h"
#include "cy_retarget_io.h"

/*******************************************************************************
* Macros
*******************************************************************************/
#define PIN_NRZI_OUTPUT    P9_0        // NRZ-I encoded output
#define BIT_DELAY_US       1000        // 1 kbps bit rate
#define SPI_BUFFER_SIZE    8

// SPI slave pins (CY8CPROTO-062-4343W Arduino header)
#define PIN_SPI_MOSI   P6_0
#define PIN_SPI_CLK    P6_2
#define PIN_SPI_CS     P6_3

/*******************************************************************************
* Global Variables
*******************************************************************************/
cyhal_spi_t spi_obj;
uint8_t spi_buffer[SPI_BUFFER_SIZE];
volatile bool data_received = false;

/*******************************************************************************
* Function Name: spi_callback
* Description: Callback called when SPI transfer completes
*******************************************************************************/
void spi_callback(void *arg, cyhal_spi_event_t event)
{
    if (event & CYHAL_SPI_IRQ_DONE)
    {
        data_received = true;
    }
}

/*******************************************************************************
* Function Name: encode_nrzi
* Description: Encode received data as NRZ-I and output on P9_0
*******************************************************************************/
void encode_nrzi(uint8_t *data, uint8_t length)
{
    bool level = false;  // Start LOW

    printf("Encoding %d bytes to NRZ-I...\r\n", length);

    for (uint8_t i = 0; i < length; i++)
    {
        uint8_t byte = data[i];

        // Process each bit (MSB first)
        for (int bit = 7; bit >= 0; bit--)
        {
            if ((byte >> bit) & 0x01)
                level = !level;  // Toggle on '1'

            // Output level
            cyhal_gpio_write(PIN_NRZI_OUTPUT, level);
            Cy_SysLib_DelayUs(BIT_DELAY_US);
        }
    }

    printf("Encoding complete.\r\n\r\n");
}

/*******************************************************************************
* Function Name: main
*******************************************************************************/
int main(void)
{
    cy_rslt_t result;

    /* Initialize board and enable global interrupts */
    cybsp_init();
    __enable_irq();

    /* Initialize UART for printf output */
    cy_retarget_io_init(CYBSP_DEBUG_UART_TX, CYBSP_DEBUG_UART_RX,
                        CY_RETARGET_IO_BAUDRATE);

    printf("\r\n=== NRZ-I Encoder ===\r\n");
    printf("SPI slave on P6_0(MOSI), P6_2(CLK), P6_3(CS)\r\n");
    printf("NRZ-I output on P9_0\r\n\r\n");

    /* Configure NRZ-I output pin */
    cyhal_gpio_init(PIN_NRZI_OUTPUT, CYHAL_GPIO_DIR_OUTPUT,
                    CYHAL_GPIO_DRIVE_STRONG, false);

    /* Initialize SPI as slave (no MISO) */
    result = cyhal_spi_init(&spi_obj,
                            PIN_SPI_MOSI,    // MOSI
                            NC,              // MISO not used
                            PIN_SPI_CLK,     // CLK
                            PIN_SPI_CS,      // CS
                            NULL,            // No rx buffer needed
                            8,               // Data width
                            CYHAL_SPI_MODE_00_MSB,
                            true);           // Slave mode

    if (result != CY_RSLT_SUCCESS)
    {
        printf("ERROR: SPI init failed (0x%08lx)\r\n", (unsigned long)result);
        CY_ASSERT(0);
    }

    cyhal_spi_set_frequency(&spi_obj, 1000000);  // 1 MHz
    cyhal_spi_register_callback(&spi_obj, spi_callback, NULL);
    cyhal_spi_enable_event(&spi_obj, CYHAL_SPI_IRQ_DONE, 3, true);

    printf("Ready. Waiting for SPI data...\r\n\r\n");

    /* Main loop */
    for (;;)
    {
        /* Start SPI receive (async transfer) */
        memset(spi_buffer, 0, SPI_BUFFER_SIZE);
        result = cyhal_spi_transfer_async(&spi_obj, NULL, 0,
                                          spi_buffer, SPI_BUFFER_SIZE);

        if (result != CY_RSLT_SUCCESS)
        {
            printf("ERROR: SPI transfer failed\r\n");
            Cy_SysLib_Delay(1000);
            continue;
        }

        /* Wait for data */
        while (!data_received)
            Cy_SysLib_Delay(10);

        data_received = false;

        /* Calculate actual received data length */
        uint8_t len = 0;
        for (uint8_t i = 0; i < SPI_BUFFER_SIZE; i++)
            if (spi_buffer[i] != 0) len = i + 1;

        if (len > 0)
        {
            printf("Received %d bytes via SPI\r\n", len);
            encode_nrzi(spi_buffer, len);
        }
    }
}
